<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Problemas IMO</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {font-family: Arial, sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:20px;}
        h1 {margin-bottom:10px;}
        .container {display:flex;gap:20px;}
        .lista {width:30%;overflow-y:auto;max-height:90vh;}
        .lista details > summary {font-weight:bold;background:#1e293b;padding:8px 12px;border-radius:6px;cursor:pointer;margin:6px 0;list-style:none;}
        .lista details details > summary {background:#334155;font-weight:normal;padding-left:20px;}
        .lista button {display:block;width:calc(100% - 40px);margin:4px 0 4px 35px;padding:8px 12px;background:#1e293b;color:white;border:none;border-radius:4px;text-align:left;cursor:pointer;}
        .lista button:hover {background:#3b82f6;}
        .lista button.feito {background:#166534;}
        .detalhe {width:70%;background:#020617;padding:20px;border-radius:8px;}
        #enunciado {line-height:1.7;font-size:1.1em;}
        .botoes {margin-top:25px;}
        .feito-btn, .solucao-btn {padding:10px 20px;background:#2563eb;border:none;color:white;border-radius:6px;cursor:pointer;}
        .feito-btn:hover, .solucao-btn:hover {background:#3b82f6;}
        #solucao {margin-top:30px;padding:20px;background:#0f172a;border-radius:8px;display:none;}
    </style>
</head>
<body>
<h1
<h1>Lista de Problemas IMO</h1>
<div class="container">
    <div class="lista" id="lista"></div>
    <div class="detalhe">
        <h2 id="titulo">Selecione um problema</h2>
        <div id="enunciado"></div>
        <div class="botoes">
            <button class="feito-btn" id="feitoBtn" style="display:none;">Marcar como feito</button>
            <button class="solucao-btn" id="solucaoBtn" style="display:none;">Mostrar solução</button>
        </div>
        <div id="solucao"></div>
    </div>
</div>

<script>
let problemas = [];
let feitos = JSON.parse(localStorage.getItem("imo-feitos") || "{}");
let atual = null;

// Mapeamento para nomes bonitos
const materiaNome = {
    algebra: "Álgebra",
    geometry: "Geometria",
    numbertheory: "Teoria dos Números",
    "number theory": "Teoria dos Números",
    combinatorics: "Combinatória"
};

fetch("problemas.json")
    .then(r => r.json())
    .then(data => {
        problemas = data;
        renderLista();
    })
    .catch(err => {
        document.getElementById("lista").innerHTML = "<p style='color:#ef4444;'>Erro ao carregar problemas.json</p>";
        console.error(err);
    });

function renderLista() {
    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    const grupos = {};

    problemas.forEach(p => {
        const partes = p.id.split('_'); // fimo_2009_numbertheory_p3
        const ano = partes[1];
        let materia = partes[2];

        // Corrige numbertheory → number theory (ou aceita os dois)
        if (materia === "numbertheory") materia = "number theory";

        const nomeMateria = materiaNome[materia] || materia.charAt(0).toUpperCase() + materia.slice(1).replace(/_/g, " ");

        if (!grupos[ano]) grupos[ano] = {};
        if (!grupos[ano][materia]) grupos[ano][materia] = { nome: nomeMateria, problemas: [] };
        grupos[ano][materia].problemas.push(p);
    });

    // Ordena anos decrescente
    const anos = Object.keys(grupos).sort((a, b) => b - a);

    anos.forEach(ano => {
        const detAno = document.createElement("details");
        detAno.open = true;
        const sumAno = document.createElement("summary");
        sumAno.textContent = `IMO ${ano}`;
        detAno.appendChild(sumAno);

        // Ordena matérias (opcional: ordem fixa)
        const materiasOrdenadas = Object.keys(grupos[ano]).sort();

        materiasOrdenadas.forEach(mat => {
            const detMat = document.createElement("details");
            detMat.open = true;
            const sumMat = document.createElement("summary");
            sumMat.textContent = grupos[ano][mat].nome;
            detMat.appendChild(sumMat);

            // Ordena problemas P1, P2, ...
            const probs = grupos[ano][mat].problemas.sort((a, b) => {
                const na = parseInt(a.id.split('_')[3].slice(1));
                const nb = parseInt(b.id.split('_')[3].slice(1));
                return na - nb;
            });

            probs.forEach(p => {
                const btn = document.createElement("button");
                btn.textContent = p.id.split('_').pop().toUpperCase(); // P1, P2...
                if (feitos[p.id]) btn.classList.add("feito");
                btn.onclick = () => abrirProblema(p);
                detMat.appendChild(btn);
            });

            detAno.appendChild(detMat);
        });

        lista.appendChild(detAno);
    });
}

function abrirProblema(p) {
    atual = p;
    document.getElementById("titulo").textContent = p.id.toUpperCase();
    document.getElementById("enunciado").innerHTML = p.enunciado || "Sem enunciado";
    document.getElementById("feitoBtn").textContent = feitos[p.id] ? "Desmarcar" : "Marcar como feito";
    document.getElementById("feitoBtn").style.display = "inline-block";
    document.getElementById("solucaoBtn").style.display = p.solucao ? "inline-block" : "none";
    document.getElementById("solucao").style.display = "none";
    document.getElementById("solucao").innerHTML = "";
    MathJax.typesetPromise();
}

document.getElementById("feitoBtn").onclick = () => {
    if (!atual) return;
    feitos[atual.id] = !feitos[atual.id];
    localStorage.setItem("imo-feitos", JSON.stringify(feitos));
    renderLista();
    document.getElementById("feitoBtn").textContent = feitos[atual.id] ? "Desmarcar" : "Marcar como feito";
};

document.getElementById("solucaoBtn").onclick = () => {
    const sol = document.getElementById("solucao");
    sol.innerHTML = atual.solucao || "Solução não disponível";
    sol.style.display = "block";
    MathJax.typesetPromise();
};
</script>
</body>
</html>
