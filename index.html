<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Problemas IMO</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {font-family: Arial, sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:20px;}
        h1 {margin-bottom:10px;}
        .container {display:flex;gap:20px;}
        .lista {width:30%;}
        .lista details summary {background:#1e293b;padding:5px;border-radius:4px;cursor:pointer;margin-bottom:4px;}
        .lista details details summary {background:#334155;}
        .lista button {width:calc(100% - 30px);padding:8px;margin-bottom:4px;margin-left:15px;background:#1e293b;color:white;border:none;cursor:pointer;text-align:left;border-radius:4px;}
        .lista button:hover {background:#334155;}
        .lista button.feito {background:#166534;}
        .detalhe {width:70%;background:#020617;padding:20px;border-radius:8px;}
        #enunciado {line-height:1.6;font-size:1.1em;}
        .botoes {margin-top:20px;}
        .feito-btn, .solucao-btn {padding:10px 18px;background:#2563eb;border:none;color:white;cursor:pointer;border-radius:4px;margin-right:12px;}
        .feito-btn:hover, .solucao-btn:hover {background:#3b82f6;}
        #solucao {margin-top:25px;padding:15px;background:#0f172a;border-radius:6px;display:none;}
    </style>
</head>
<body>
<h1>Lista de Problemas IMO</h1>
<div class="container">
    <div class="lista" id="lista"></div>
    <div class="detalhe">
        <h2 id="titulo">Selecione um problema</h2>
        <div id="enunciado"></div>
        <div class="botoes">
            <button class="feito-btn" id="feitoBtn" style="display:none;">Marcar como feito</button>
            <button class="solucao-btn" id="solucaoBtn" style="display:none;">Mostrar solução</button>
        </div>
        <div id="solucao"></div>
    </div>
</div>

<script>
let problemas = [];
let feitos = JSON.parse(localStorage.getItem("imo-feitos") || "{}");
let atual = null;

fetch("problemas.json")
    .then(r => r.json())
    .then(data => {
        problemas = data;
        renderLista();
    })
    .catch(err => {
        document.getElementById("lista").innerHTML = "<p style='color:#ef4444;'>Erro ao carregar problemas.json</p>";
        console.error(err);
    });

function renderLista() {
    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    let groups = {};
    problemas.forEach(p => {
        let parts = p.id.split('_');
        let year = parts[1];
        let subject_key = parts[2];
        let subject = subject_key.replace(/_/g, ' ');
        if (!groups[year]) groups[year] = {};
        if (!groups[year][subject_key]) groups[year][subject_key] = { display: subject, probs: [] };
        groups[year][subject_key].probs.push(p);
    });

    let years = Object.keys(groups).sort((a,b) => b - a); // descending for recent first

    years.forEach(year => {
        let yearDet = document.createElement('details');
        let yearSum = document.createElement('summary');
        yearSum.textContent = `Ano ${year}`;
        yearDet.appendChild(yearSum);

        let subjects = Object.keys(groups[year]).sort();
        subjects.forEach(subject_key => {
            let subjDet = document.createElement('details');
            let subjSum = document.createElement('summary');
            subjSum.textContent = groups[year][subject_key].display.charAt(0).toUpperCase() + groups[year][subject_key].display.slice(1);
            subjDet.appendChild(subjSum);

            let probs = groups[year][subject_key].probs.sort((a,b) => {
                let pa = parseInt(a.id.split('_')[3].substring(1));
                let pb = parseInt(b.id.split('_')[3].substring(1));
                return pa - pb;
            });

            probs.forEach(p => {
                const btn = document.createElement("button");
                btn.textContent = p.id.split('_')[3].toUpperCase();
                if (feitos[p.id]) btn.classList.add("feito");
                btn.onclick = () => abrirProblema(p);
                subjDet.appendChild(btn);
            });

            yearDet.appendChild(subjDet);
        });

        lista.appendChild(yearDet);
    });
}

function abrirProblema(p) {
    atual = p;
    document.getElementById("titulo").textContent = p.id;
    document.getElementById("enunciado").innerHTML = p.enunciado || "Sem enunciado";
    document.getElementById("feitoBtn").textContent = feitos[p.id] ? "Desmarcar" : "Marcar como feito";
    document.getElementById("feitoBtn").style.display = "inline-block";
    document.getElementById("solucaoBtn").style.display = p.solucao ? "inline-block" : "none";
    document.getElementById("solucao").style.display = "none";
    document.getElementById("solucao").innerHTML = "";
    MathJax.typesetPromise().catch(err => console.error(err));
}

document.getElementById("feitoBtn").onclick = () => {
    if (!atual) return;
    feitos[atual.id] = !feitos[atual.id];
    localStorage.setItem("imo-feitos", JSON.stringify(feitos));
    renderLista();
    document.getElementById("feitoBtn").textContent = feitos[atual.id] ? "Desmarcar" : "Marcar como feito";
};

document.getElementById("solucaoBtn").onclick = () => {
    const sol = document.getElementById("solucao");
    sol.innerHTML = atual.solucao || "Solução não disponível";
    sol.style.display = "block";
    MathJax.typesetPromise().catch(err => console.error(err));
};
</script>
</body>
</html>
