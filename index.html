<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Problemas IMO</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {font-family: Arial, sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:20px;}
        h1 {margin-bottom:10px;}
        .container {display:flex;gap:20px;}
        .lista {width:30%;overflow-y:auto;max-height:92vh;}
        .lista > details > summary {
            font-weight:bold;background:#1e293b;padding:12px 16px;border-radius:8px;
            cursor:pointer;list-style:none;font-size:1.15em;margin:8px 0;
        }
        .lista details details > summary {
            background:#334155;padding:9px 16px 9px 34px;border-radius:6px;
            cursor:pointer;list-style:none;
        }
        .lista button {
            display:block;width:calc(100% - 60px);margin:5px 0 5px 54px;
            padding:10px 16px;background:#1e293b;color:white;border:none;
            border-radius:6px;text-align:left;cursor:pointer;
        }
        .lista button:hover {background:#3b82f6;}
        .lista button.feito {background:#166534;}
        .lista .versao {margin-left:70px;font-size:0.9em;color:#94a3b8;}
        .detalhe {width:70%;background:#020617;padding:25px;border-radius:10px;}
        #enunciado {line-height:1.8;font-size:1.15em;margin-bottom:20px;}
        .botoes {margin-top:20px;}
        .feito-btn, .solucao-btn {padding:12px 26px;background:#2563eb;border:none;color:white;
            border-radius:6px;cursor:pointer;margin-right:12px;}
        #solucao {margin-top:30px;padding:20px;background:#0f172a;border-radius:8px;display:none;}
    </style>
</head>
<body>
<h1>Lista de Problemas IMO</h1>
<div class="container">
    <div class="lista" id="lista"></div>
    <div class="detalhe">
        <h2 id="titulo">Selecione um problema</h2>
        <div id="enunciado"></div>
        <div class="botoes">
            <button class="feito-btn" id="feitoBtn" style="display:none;">Marcar como feito</button>
            <button class="solucao-btn" id="solucaoBtn" style="display:none;">Mostrar solução</button>
        </div>
        <div id="solucao"></div>
    </div>
</div>

<script>
let problemas = [];
let feitos = JSON.parse(localStorage.getItem("imo-feitos") || "{}");
let atual = null;

const nomesMaterias = {
    algebra: "Álgebra",
    geometry: "Geometria",
    numbertheory: "Teoria dos Números",
    "number theory": "Teoria dos Números",
    number_theory: "Teoria dos Números",
    combinatorics: "Combinatória",
    inequalities: "Desigualdades"
};

fetch("problemas.json")
    .then(r => r.json())
    .then(data => {
        problemas = data;
        renderLista();
    })
    .catch(() => {
        document.getElementById("lista").innerHTML = "<p style='color:#ef4444;'>problemas.json não encontrado</p>";
    });

function renderLista() {
    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    const grupos = {};

    problemas.forEach(p => {
        const idLower = p.id.toLowerCase();
        const partes = idLower.split('_');
        const ano = partes[1];
        let materia = partes[2];

        if (materia.includes("number") || materia === "numbertheory") materia = "number theory";

        const nomeMateria = nomesMaterias[materia] || materia.split('_').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');

        // Detecta número do problema e possível versão/sufixo
        const resto = partes.slice(3).join('_'); // p8_1 ou p3a ou p6
        const match = resto.match(/^p(\d+)([ab]?|_(\d+))?$/);
        const num = match ? match[1] : "0";
        const sufixo = match && match[3] ? match[3] : (match && match[2] ? match[2].toUpperCase() : "");

        const display = sufixo ? `P${num} (${sufixo})` : `P${num}`;

        if (!grupos[ano]) grupos[ano] = {};
        if (!grupos[ano][materia]) grupos[ano][materia] = { nome: nomeMateria, probs: [] };
        grupos[ano][materia].probs.push({ ...p, display, num: parseInt(num) });
    });

    const anos = Object.keys(grupos).sort((a,b) => b - a);

    anos.forEach(ano => {
        const detAno = document.createElement("details");
        detAno.open = ano == anos[0];

        const sumAno = document.createElement("summary");
        sumAno.textContent = `IMO ${ano}`;
        detAno.appendChild(sumAno);

        const ordem = ["algebra", "geometry", "number theory", "combinatorics", "inequalities"];
        const materias = Object.keys(grupos[ano]).sort((a,b) => {
            const ia = ordem.indexOf(a);
            const ib = ordem.indexOf(b);
            return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
        });

        materias.forEach(mat => {
            const info = grupos[ano][mat];
            const detMat = document.createElement("details");

            const sumMat = document.createElement("summary");
            sumMat.textContent = info.nome;
            detMat.appendChild(sumMat);

            // Agrupa por número base (P8, P3 etc)
            const porNumero = {};
            info.probs.forEach(item => {
                if (!porNumero[item.num]) porNumero[item.num] = [];
                porNumero[item.num].push(item);
            });

            Object.keys(porNumero).sort((a,b) => a - b).forEach(n => {
                const itens = porNumero[n];

                if (itens.length === 1) {
                    // Problema normal
                    const btn = document.createElement("button");
                    btn.textContent = itens[0].display;
                    if (feitos[itens[0].id]) btn.classList.add("feito");
                    btn.onclick = () => abrirProblema(itens[0]);
                    detMat.appendChild(btn);
                } else {
                    // Tem versões (ex: P8 (1), P8 (2) ou P3A, P3B)
                    const baseBtn = document.createElement("button");
                    baseBtn.textContent = `P${n}`;
                    baseBtn.style.fontWeight = "bold";
                    if (itens.every(i => feitos[i.id])) baseBtn.classList.add("feito");
                    detMat.appendChild(baseBtn);

                    itens.sort((a,b) => a.display.localeCompare(b.display)).forEach(item => {
                        const vBtn = document.createElement("div");
                        vBtn.className = "versao";
                        vBtn.textContent = `↳ ${item.display}`;
                        if (feitos[item.id]) vBtn.style.color = "#86efac";
                        vBtn.style.cursor = "pointer";
                        vBtn.onclick = (e) => {
                            e.stopPropagation();
                            abrirProblema(item);
                        };
                        detMat.appendChild(vBtn);
                    });
                }
            });

            detAno.appendChild(detMat);
        });

        lista.appendChild(detAno);
    });
}

function abrirProblema(p) {
    atual = p;
    document.getElementById("titulo").textContent = p.id.toUpperCase();
    document.getElementById("enunciado").innerHTML = p.enunciado || "Sem enunciado";
    document.getElementById("feitoBtn").textContent = feitos[p.id] ? "Desmarcar" : "Marcar como feito";
    document.getElementById("feitoBtn").style.display = "inline-block";
    document.getElementById("solucaoBtn").style.display = p.solucao ? "inline-block" : "none";
    document.getElementById("solucao").style.display = "none";
    document.getElementById("solucao").innerHTML = "";
    MathJax.typesetPromise();
}

document.getElementById("feitoBtn").onclick = () => {
    if (!atual) return;
    feitos[atual.id] = !feitos[atual.id];
    localStorage.setItem("imo-feitos", JSON.stringify(feitos));
    renderLista();
    document.getElementById("feitoBtn").textContent = feitos[atual.id] ? "Desmarcar" : "Marcar como feito";
};

document.getElementById("solucaoBtn").onclick = () => {
    const sol = document.getElementById("solucao");
    sol.innerHTML = atual.solucao || "Solução não disponível";
    sol.style.display = "block";
    MathJax.typesetPromise();
};
</script>
</body>
</html>
