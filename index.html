<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Lista de Problemas IMO</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          displayMath: [['$$', '$$'], ['\\[', '\\]']],
          processEscapes: true
        }
      };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body {font-family: Arial, sans-serif;background:#0f172a;color:#e5e7eb;margin:0;padding:20px;}
        h1 {margin-bottom:10px;}
        .container {display:flex;gap:20px;}
        .lista {width:30%;overflow-y:auto;max-height:92vh;}
        .lista details > summary {
            display:block;margin:8px 0;
        }
        .lista > details > summary {
            font-weight:bold;background:#1e293b;padding:12px 16px;border-radius:8px;
            cursor:pointer;list-style:none;font-size:1.15em;
        }
        .lista details details > summary {
            background:#334155;padding:9px 16px 9px 34px;
            cursor:pointer;list-style:none;border-radius:6px;
            font-size:1em;
        }
        .lista button {
            display:block;width:calc(100% - 60px);margin:5px 0 5px 54px;
            padding:10px 16px;background:#1e293b;color:white;border:none;
            border-radius:6px;text-align:left;cursor:pointer;font-size:0.98em;
        }
        .lista button:hover {background:#3b82f6;}
        .lista button.feito {background:#166534;}
        .detalhe {width:70%;background:#020617;padding:25px;border-radius:10px;}
        #enunciado {line-height:1.8;font-size:1.15em;margin-bottom:20px;}
        .botoes {margin-top:20px;}
        .feito-btn, .solucao-btn {padding:12px 26px;background:#2563eb;border:none;color:white;
            border-radius:6px;cursor:pointer;font-size:1em;margin-right:12px;}
        #solucao {margin-top:30px;padding:20px;background:#0f172a;border-radius:8px;display:none;}
    </style>
</head>
<body>
<h1>Lista de Problemas IMO</h1>
<div class="container">
    <div class="lista" id="lista"></div>
    <div class="detalhe">
        <h2 id="titulo">Selecione um problema</h2>
        <div id="enunciado"></div>
        <div class="botoes">
            <button class="feito-btn" id="feitoBtn" style="display:none;">Marcar como feito</button>
            <button class="solucao-btn" id="solucaoBtn" style="display:none;">Mostrar solução</button>
        </div>
        <div id="solucao"></div>
    </div>
</div>

<script>
let problemas = [];
let feitos = JSON.parse(localStorage.getItem("imo-feitos") || "{}");
let atual = null;

// Nomes bonitos das matérias
const nomesMaterias = {
    algebra: "Álgebra",
    geometry: "Geometria",
    numbertheory: "Teoria dos Números",
    "number theory": "Teoria dos Números",
    number_theory: "Teoria dos Números",
    combinatorics: "Combinatória",
    inequalities: "Desigualdades"
};

fetch("problemas.json")
    .then(r => r.json())
    .then(data => {
        problemas = data;
        renderLista();
    })
    .catch(() => {
        document.getElementById("lista").innerHTML = "<p style='color:#ef4444;'>problemas.json não encontrado</p>";
    });

function renderLista() {
    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    const grupos = {};

    problemas.forEach(p => {
        const id = p.id.toLowerCase();                 // garante lowercase
        const partes = id.split('_');                  // fimo_2009_numbertheory_p3
        const ano = partes[1];
        let materia = partes[2];

        // Padroniza number theory de qualquer jeito
        if (materia.includes("number") || materia === "numbertheory") {
            materia = "number theory";
        }

        const nomeMateria = nomesMaterias[materia] || materia.split('_').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');

        if (!grupos[ano]) grupos[ano] = {};
        if (!grupos[ano][materia]) grupos[ano][materia] = { nome: nomeMateria, probs: [] };
        grupos[ano][materia].probs.push(p);
    });

    const anos = Object.keys(grupos).sort((a,b) => b - a);

    anos.forEach(ano => {
        const detAno = document.createElement("details");
        // Só o ano mais recente aberto
        detAno.open = ano == anos[0];

        const sumAno = document.createElement("summary");
        sumAno.textContent = `IMO ${ano}`;
        detAno.appendChild(sumAno);

        // Ordem fixa das matérias (opcional, mas fica bonito)
        const ordem = ["algebra", "geometry", "number theory", "combinatorics", "inequalities"];
        const materias = Object.keys(grupos[ano]).sort((a,b) => {
            const ia = ordem.indexOf(a);
            const ib = ordem.indexOf(b);
            return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
        });

        materias.forEach(mat => {
            const info = grupos[ano][mat];
            const detMat = document.createElement("details");
            detMat.open = false; // matérias começam fechadas

            const sumMat = document.createElement("summary");
            sumMat.textContent = info.nome;
            detMat.appendChild(sumMat);

            info.probs
                .sort((a,b) => {
                    const na = parseInt(a.id.split('_')[3].slice(1));
                    const nb = parseInt(b.id.split('_')[3].slice(1));
                    return na - nb;
                })
                .forEach(p => {
                    const btn = document.createElement("button");
                    btn.textContent = p.id.split('_').pop().toUpperCase();
                    if (feitos[p.id]) btn.classList.add("feito");
                    btn.onclick = () => abrirProblema(p);
                    detMat.appendChild(btn);
                });

            detAno.appendChild(detMat);
        });

        lista.appendChild(detAno);
    });
}

function abrirProblema(p) {
    atual = p;
    document.getElementById("titulo").textContent = p.id.toUpperCase();
    document.getElementById("enunciado").innerHTML = p.enunciado || "Sem enunciado";
    document.getElementById("feitoBtn").textContent = feitos[p.id] ? "Desmarcar" : "Marcar como feito";
    document.getElementById("feitoBtn").style.display = "inline-block";
    document.getElementById("solucaoBtn").style.display = p.solucao ? "inline-block" : "none";
    document.getElementById("solucao").style.display = "none";
    document.getElementById("solucao").innerHTML = "";
    MathJax.typesetPromise();
}

document.getElementById("feitoBtn").onclick = () => {
    if (!atual) return;
    feitos[atual.id] = !feitos[atual.id];
    localStorage.setItem("imo-feitos", JSON.stringify(feitos));
    renderLista();
    document.getElementById("feitoBtn").textContent = feitos[atual.id] ? "Desmarcar" : "Marcar como feito";
};

document.getElementById("solucaoBtn").onclick = () => {
    const sol = document.getElementById("solucao");
    sol.innerHTML = atual.solucao || "Solução não disponível";
    sol.style.display = "block";
    MathJax.typesetPromise();
};
</script>
</body>
</html>
